{%- liquid
  assign se_id = section.id
  assign se_bks = section.blocks
  assign se_stts = section.settings
-%}
<style scoped>
  .header__linklist-link {
    font-size: 1em;
  }

  #blog-product-plugin-two {
    display: none;
  }

  .blogSubmitEmailHtml {
    width: 100%;
    font-size: 1em;
    display: flex;
    justify-content: center;
    align-items: center;
    padding: 2em 0;
  }

  .blogSubmitEmailHtml .product-container {
    width: 100%;
    display: flex;
    justify-content: flex-start;
    align-items: center;
    gap: 3em;
    box-sizing: border-box;
    background: url('https://cdn.shopify.com/s/files/1/0841/4596/3322/files/product_2_img_fbe5097b-25fd-4679-81dd-db5ae1bc2bf1.png?v=1748946059')
      no-repeat center / cover;
  }

  .blogSubmitEmailHtml .subscribe-section {
    width: 30em;
    padding: 1em 0 1em 3em;
  }

  .blogSubmitEmailHtml .form-row {
    display: flex;
    align-items: center;
    gap: 1em;
    margin-bottom: 1em;
    flex-wrap: wrap;
  }

  .blogSubmitEmailHtml .email-title {
    color: #fff;
    font-family: Saans;
    font-size: 30px;
    font-weight: 500;
    text-align: center;
    line-height: 32px;
    margin-bottom: 20px;
    {% comment %} margin-bottom: 1em; {% endcomment %}
  }

  .blogSubmitEmailHtml .email-desc {
    font-size: 14px;
  }

  .blogSubmitEmailHtml .email-input {
    flex: 1 1 100%;
    padding: 0 20px;
    font-size: 16px;
    border: 1px solid #ccc;
    box-sizing: border-box;
    height: 42px;
  }

  .blogSubmitEmailHtml .submit-btn-blog {
    flex: 1 1 100%;
    background-color: #e0004d;
    color: white;
    border: none;
    cursor: pointer;
    white-space: nowrap;
    box-sizing: border-box;
    text-align: center;
    height: 50px;
    font-size: 18px;
    border-radius: 4px;
  }

  .blogSubmitEmailHtml .submit-btn-blog:hover {
    background-color: #c30043;
  }

  .blogSubmitEmailHtml .terms {
    color: #f9f6fa;
    font-family: Saans;
    font-size: 1em;
    text-align: left;
    line-height: 1.5;
  }

  .blogSubmitEmailHtml .terms label {
    display: flex;
    align-items: flex-start;
    gap: 0.2em;
  }

  .blogSubmitEmailHtml .terms input[type='checkbox'] {
    width: 1em;
    height: 1em;
    margin-top: 0.3em;
    flex-shrink: 0;
  }

  .blogSubmitEmailHtml .terms a {
    color: #ffffff;
    text-decoration: underline;
    text-decoration-color: #fff !important;
  }

  .global-message-box {
    display: flex;
    align-items: center;
  }

  .global-message-box .global-message-content {
    font-size: 1em;
    text-align: left;
    color: #e0004d;
  }

  .global-message-box .message-icon {
    width: 1.3em;
    height: 1.3em;
    border-radius: 50%;
    background-color: #e0004d;
    color: white;
    font-weight: bold;
    display: flex;
    align-items: center;
    justify-content: center;
    margin-right: 0.2em;
    font-size: 1em;
    flex-shrink: 0;
  }

  @media (max-width: 480px) {
    .blogSubmitEmailHtml {
      font-size: 0.75em;
    }

    .blogSubmitEmailHtml .product-container {
      {% comment %} height: 48em;
      justify-content: center;
      gap: 2em;
      background: url(https://cdn.shopify.com/s/files/1/0656/9079/6273/files/222a2339-4ada-4a61-aab7-7853b018d14a.png?v=1749198407)
        no-repeat left center;
      background-size: 265%;
      background-position: -26em -14em; {% endcomment %}
      justify-content: center;
      height: 400px;
      background: url(https://cdn.shopify.com/s/files/1/0656/9079/6273/files/222a2339-4ada-4a61-aab7-7853b018d14a.png?v=1749198407) center center;
      background-size: cover;
    }

    .blogSubmitEmailHtml .subscribe-section {
      width: 32em;
      padding: 0 2em;
    }

    .blogSubmitEmailHtml .email-title {
      font-size: 24px;
      text-align: center;
    }

    .blogSubmitEmailHtml .email-input {
      padding: 0.6em;
      font-size: 1em;
    }

    .blogSubmitEmailHtml .submit-btn-blog {
      {% comment %} padding: 0.8em 2em;
      font-size: 1em; {% endcomment %}
      font-size: 18px;
    }

    .blogSubmitEmailHtml .terms {
      font-size: 1em;
      margin:10px 0;
    }

    .blogSubmitEmailHtml .terms input[type='checkbox'] {
      {% comment %} width: 1.5em;
      height: 1.5em;
      margin-top: 0em; {% endcomment %}
      width: 15px;
      height: 15px;
    }

    .global-message-box .global-message-content {
      font-size: 2em;
    }
  }
</style>

{%- liquid
  assign se_id = section.id
  assign se_bks = section.blocks
  assign se_stts = section.settings
-%}
<div id="blog-product-plugin-two">
  <div class="blogSubmitEmailHtml" data-sort="{{ se_stts.sort }}">
    <div class="product-container">
      <div class="subscribe-section">
        <div class="email-title">{{ se_stts.title }}</div>
        <div class="form-row">
          <input type="email" class="email-input" placeholder="Enter your e-mail">
          <div class="terms">
            <label>
              <input type="checkbox">
              <span class="email-desc">
                {{ se_stts.privacy_html }}
              </span>
            </label>
          </div>
          <button class="submit-btn-blog">{{ se_stts.btn_text }}</button>
          <div class="global-message-box" style="display: none;">
            <span class="message-icon">!</span>
            <span class="global-message-content"> Message</span>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>
<script>
  window.addEventListener("load", function () {
    const $template = $('#blog-product-plugin-two .blogSubmitEmailHtml'); // 模板
    const templateClass = "{{ se_stts.className }}";

    // 遍历目标 class 匹配
    $(`.${templateClass}`).each(function () {
      const $target = $(this);
      const sort = $target.data('sort'); // 目标的 data-sort

      // 克隆模板
      const $newBlock = $template.clone();
      $newBlock.attr('data-sort', sort); // 设置 sort

      // 查找对应 sort 的 ipl-email 区块
      const $ipl = $(`.ipl-email[data-sort="${sort}"]`);
      const headline = $ipl.data('cta-headline') || "{{ se_stts.title }}";
      const userTag = $ipl.data('cta-user') || 'seo_blog_subscribe';

      // 注入 headline 到标题
      $newBlock.find('.email-title').text(headline);

      // 注入 headline 到隐私 span 中（可选：.html() 支持富文本）
      {% comment %} $newBlock.find('.terms span').text(headline); {% endcomment %}

      // 存储 tag、headline 到新模块 data 属性
      $newBlock.attr('data-headline', headline);
      $newBlock.attr('data-tag', userTag);

      // 替换旧 DOM
      $target.replaceWith($newBlock);
    });

    // 提交事件
    $(document).on('click', '.submit-btn-blog', function () {
      const $btn = $(this);
      const $block = $btn.closest('.blogSubmitEmailHtml');
      const sort = $block.data('sort');
      const userEmail = $block.find('.email-input').val();

      const headline = $block.data('headline') || '';
      const tagText = $block.data('tag') || 'bottom-subscribe';
      console.log('sort',sort)
      const data = {
        userEmail: userEmail,
        since: "PAGE_BOTTOM_SUBSCRIBE",
        tags: [tagText],
      };
       // 校验：必须勾选 checkbox
      const $checkbox = $block.find('input[type="checkbox"]');
      if (!userEmail) {
        showMessage($block, 'Please enter your email address.',false); // 全局提示
        return;
      }
     if (!$checkbox.prop('checked')) {
        showMessage($block, 'Please agree to our privacy policy.',false); // 提示
        return;
      }
      sendUlikeApi('/user/userSubscribe', data).then(function (res) {
        if (res.code == 0) {
          $block.find('.email-input').val('');
           $block.find('input[type="checkbox"]').prop('checked', false);
           {% comment %} $block.find('.global-message-box').fadeOut(); {% endcomment %}
           showMessage($block, 'You have been subscribed to our newsletter.',true);
        } else {
          showMessage($block, 'Please enter your email address.',false);
        }
      });

      function showMessage($container, text, isSuccess = false) {
           const $msgBox = $container.find('.global-message-box');
            const $icon = $msgBox.find('.message-icon');
            const $content = $msgBox.find('.global-message-content');

            // 设置文字
            $content.text(text);

            // ✅ 切换样式
            if (isSuccess) {
              $icon.css('background-color', '#00b341'); // 绿色
              $content.css('color', '#00b341');
              $icon.text('✓'); // 打钩
            } else {
              $icon.css('background-color', '#e0004d'); // 红色
              $content.css('color', '#e0004d');
              $icon.text('!'); // 感叹号
            }

            // 显示提示
            $msgBox.fadeIn();

            // 自动隐藏
            setTimeout(() => {
              $msgBox.fadeOut();
            }, 3000);
        }
    });
  });
</script>
{% schema %}
{
  "name": "b-blog-submit-email",
  "class": "b-blog-submit-email",
  "blocks": [
    {
      "name": "social-item",
      "type": "social-item",
      "settings": [
        {
          "type": "url",
          "id": "link",
          "label": "链接"
        },
        {
          "type": "html",
          "id": "svg",
          "label": "svg文本"
        }
      ]
    }
  ],
  "settings": [
    {
      "type": "text",
      "id": "className",
      "label": "class名称"
    },
    {
      "type": "text",
      "id": "title",
      "label": "标题"
    },

    {
      "type": "text",
      "id": "btn_text",
      "label": "按钮名称",
      "default": "Submit"
    },
    {
      "type": "html",
      "id": "privacy_html",
      "label": "政策隐私条款"
    }
  ],
  "presets": [
    {
      "name": "b-blog-submit-email",
      "blocks": []
    }
  ]
}
{% endschema %}
